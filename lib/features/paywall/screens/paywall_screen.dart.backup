// import 'dart:async';

// import 'package:adapty_flutter/adapty_flutter.dart';
// import 'package:faithlock/app_routes.dart';
// import 'package:faithlock/core/constants/app_colors.dart';
// import 'package:faithlock/core/constants/app_constants.dart';
// import 'package:faithlock/services/adapty_service.dart';
// import 'package:flutter/cupertino.dart';
// import 'package:flutter/material.dart';
// import 'package:get/get.dart';
// import 'package:url_launcher/url_launcher.dart';

// class PaywallScreen extends StatefulWidget {
//   final String placementId;
//   bool redirectToHomeOnClose;
//   PaywallScreen(
//       {super.key,
//       required this.placementId,
//       this.redirectToHomeOnClose = false});

//   @override
//   State<PaywallScreen> createState() => _PaywallScreenState();
// }

// class _PaywallScreenState extends State<PaywallScreen>
//     with TickerProviderStateMixin {
//   int selectedPlan = 1;
//   bool freeTrialEnabled = true;

//   final AdaptyPurchaseService _adaptyService = AdaptyPurchaseService();
//   late AnimationController _switchAnimationController;
//   late AnimationController _cardAnimationController;
//   late Animation<double> _switchAnimation;
//   late Animation<double> _cardScaleAnimation;

//   AdaptyPaywall? _paywall;
//   List<AdaptyPaywallProduct> _products = [];
//   bool _isLoading = true;
//   String? _error;
//   bool _isPurchasing = false;

//   @override
//   void initState() {
//     super.initState();
//     _initializeAnimations();
//     _loadAdaptyData();
//   }

//   void _initializeAnimations() {
//     _switchAnimationController = AnimationController(
//       duration: const Duration(milliseconds: 400),
//       vsync: this,
//     );
//     _cardAnimationController = AnimationController(
//       duration: const Duration(milliseconds: 200),
//       vsync: this,
//     );
//     _switchAnimation = CurvedAnimation(
//       parent: _switchAnimationController,
//       curve: Curves.easeInOut,
//     );
//     _cardScaleAnimation = Tween<double>(
//       begin: 1.0,
//       end: 0.995,
//     ).animate(CurvedAnimation(
//       parent: _cardAnimationController,
//       curve: Curves.easeInOut,
//     ));
//   }

//   @override
//   void dispose() {
//     _switchAnimationController.dispose();
//     _cardAnimationController.dispose();
//     super.dispose();
//   }

//   void _selectPlan(int planIndex, String period) async {
//     _cardAnimationController.forward().then((_) {
//       _cardAnimationController.reverse();
//     });

//     setState(() {
//       selectedPlan = planIndex;
//       freeTrialEnabled = period != 'yearly';
//     });

//     if (period == 'yearly') {
//       _switchAnimationController.reverse();
//     } else {
//       _switchAnimationController.forward();
//     }
//   }

//   void _toggleFreeTrialWithPlanSelection(bool value) async {
//     setState(() {
//       freeTrialEnabled = value;
//       if (value && _isCurrentPlanYearly()) {
//         selectedPlan = _findNonYearlyPlanIndex();
//       }
//       if (!value) {
//         selectedPlan = _findYearlyPlanIndex();
//       }
//     });

//     if (value) {
//       _switchAnimationController.forward();
//     } else {
//       _switchAnimationController.reverse();
//     }
//   }

//   bool _isCurrentPlanYearly() {
//     if (_products.isNotEmpty && selectedPlan < _products.length) {
//       return _getSubscriptionPeriod(_products[selectedPlan]) == 'yearly';
//     }
//     return selectedPlan == 0;
//   }

//   int _findYearlyPlanIndex() {
//     if (_products.isNotEmpty) {
//       for (int i = 0; i < _products.length; i++) {
//         if (_getSubscriptionPeriod(_products[i]) == 'yearly') {
//           return i;
//         }
//       }
//     }
//     return 0;
//   }

//   int _findNonYearlyPlanIndex() {
//     if (_products.isNotEmpty) {
//       for (int i = 0; i < _products.length; i++) {
//         if (_getSubscriptionPeriod(_products[i]) != 'yearly') {
//           return i;
//         }
//       }
//     }
//     return 1;
//   }

//   Future<void> _loadAdaptyData() async {
//     try {
//       // Vérifier si les données sont déjà en cache
//       final isCached =
//           _adaptyService.isPaywallCached(AppConstants.onboardingPaywallId);

//       if (!isCached) {
//         setState(() {
//           _isLoading = true;
//           _error = null;
//         });
//       }

//       // Vérifier d'abord si le pré-chargement est terminé
//       if (!_adaptyService.isPreloadComplete && !isCached) {
//         // Si pas terminé, attendre un maximum de 2 secondes
//         final completer = Completer<void>();
//         final timer = Timer(const Duration(seconds: 2), () {
//           if (!completer.isCompleted) completer.complete();
//         });

//         // Attendre que le pré-chargement soit terminé ou timeout
//         while (!_adaptyService.isPreloadComplete && !completer.isCompleted) {
//           await Future.delayed(const Duration(milliseconds: 100));
//         }

//         timer.cancel();
//       }

//       final paywall = await _adaptyService
//           .getPaywallForDefaultAudience(AppConstants.onboardingPaywallId);

//       if (paywall != null) {
//         final products = await _adaptyService.getPaywallProducts(paywall);
//         products?.removeWhere(
//             (prod) => prod.subscription?.period.unit == AdaptyPeriodUnit.month);

//         setState(() {
//           _paywall = paywall;
//           _products = products ?? [];
//           _isLoading = false;
//         });

//         await _adaptyService.logShowPaywall(paywall);
//       } else {
//         setState(() {
//           _error = 'Failed to load subscription options';
//           _isLoading = false;
//         });
//       }
//     } catch (e) {
//       setState(() {
//         _error = 'Failed to load subscription options: $e';
//         _isLoading = false;
//       });
//     }
//   }

//   @override
//   Widget build(BuildContext context) {
//     final theme = Theme.of(context);
//     final isDark = theme.brightness == Brightness.dark;

//     return Scaffold(
//       backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
//       appBar: AppBar(
//         backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
//         elevation: 0,
//         leading: const SizedBox(
//           width: 48,
//         ),
//         title: _buildHeader(isDark),
//         actions: [
//           StatefulBuilder(
//             builder: (context, setState) {
//               return TweenAnimationBuilder<double>(
//                 tween: Tween(begin: 0.0, end: 1.0),
//                 duration: const Duration(seconds: 5),
//                 builder: (context, value, child) {
//                   if (value < 1.0) {
//                     return Container(
//                       height: 24,
//                       width: 24,
//                       margin: const EdgeInsets.only(right: 8),
//                       child: CircularProgressIndicator(
//                         strokeWidth: 2,
//                         value: value,
//                         valueColor:
//                             const AlwaysStoppedAnimation<Color>(Colors.grey),
//                         backgroundColor: Colors.grey.withAlpha(51),
//                       ),
//                     );
//                   }
//                   return GestureDetector(
//                     onTap: () {
//                       if (widget.redirectToHomeOnClose) {
//                         Navigator.of(context)
//                             .popUntil((route) => route.isFirst);
//                       } else {
//                         Navigator.of(context).pop();
//                       }
//                     },
//                     child: Container(
//                       width: 32,
//                       height: 32,
//                       margin: const EdgeInsets.only(right: 8),
//                       decoration: BoxDecoration(
//                         color: Colors.black.withValues(alpha: 0.08),
//                         shape: BoxShape.circle,
//                       ),
//                       child: const Icon(
//                         Icons.close,
//                         size: 18,
//                         color: Colors.black54,
//                       ),
//                     ),
//                   );
//                 },
//               );
//             },
//           ),
//         ],
//       ),
//       body: SafeArea(
//         top: false,
//         bottom: false,
//         child: Column(
//           children: [
//             Expanded(
//               child: _isLoading
//                   ? _buildLoadingState(isDark)
//                   : _error != null
//                       ? _buildErrorState(isDark)
//                       : Padding(
//                           padding: const EdgeInsets.symmetric(horizontal: 20.0),
//                           child: Column(
//                             crossAxisAlignment: CrossAxisAlignment.center,
//                             mainAxisAlignment: MainAxisAlignment.center,
//                             children: [
//                               // Visual representation
//                               _buildVisualRepresentation(),

//                               SizedBox(height: selectedPlan == 1 ? 12 : 48),

//                               // Features list
//                               Flexible(child: _buildFeaturesList(isDark)),

//                               SizedBox(height: selectedPlan == 1 ? 8 : 20),

//                               // Pricing plans
//                               _buildPricingPlans(isDark),

//                               const SizedBox(height: 12),

//                               // Free trial toggle
//                               _buildFreeTrialToggle(isDark),

//                               SizedBox(height: selectedPlan == 1 ? 16 : 8),

//                               // Unlock button
//                               Column(
//                                 children: [
//                                   if (selectedPlan == 1) ...[
//                                     Text(
//                                       'Cancel anytime on the App Store',
//                                       style: TextStyle(
//                                           color: isDark
//                                               ? Colors.white70
//                                               : Colors.black54,
//                                           fontSize: 12,
//                                           fontWeight: FontWeight.w500),
//                                     ),
//                                     const SizedBox(height: 8),
//                                   ],
//                                   _buildUnlockButton(),
//                                 ],
//                               ),

//                               const SizedBox(height: 12),

//                               // Footer links
//                               _buildFooterLinks(isDark),

//                               const SizedBox(height: 16),
//                             ],
//                           ),
//                         ),
//             ),
//           ],
//         ),
//       ),
//     );
//   }

//   Widget _buildLoadingState(bool isDark) {
//     // return Center(
//     //   child: Column(
//     //     mainAxisAlignment: MainAxisAlignment.center,
//     //     children: [
//     //       CircularProgressIndicator(
//     //         valueColor: AlwaysStoppedAnimation<Color>(
//     //           isDark ? Colors.white : AppColors.primary,
//     //         ),
//     //       ),
//     //       const SizedBox(height: 16),
//     //       Text(
//     //         'Loading subscription options...',
//     //         style: TextStyle(
//     //           color: isDark ? Colors.white70 : Colors.black54,
//     //           fontSize: 16,
//     //         ),
//     //       ),
//     //     ],
//     //   ),
//     // );
//     return Center(
//       child: CircularProgressIndicator.adaptive(
//         valueColor: AlwaysStoppedAnimation<Color>(
//           isDark ? Colors.white : AppColors.primary,
//         ),
//       ),
//     );
//   }

//   Widget _buildErrorState(bool isDark) {
//     return Center(
//       child: Padding(
//         padding: const EdgeInsets.all(20.0),
//         child: Column(
//           mainAxisAlignment: MainAxisAlignment.center,
//           children: [
//             Icon(
//               Icons.error_outline,
//               size: 64,
//               color: isDark ? Colors.white54 : Colors.black26,
//             ),
//             const SizedBox(height: 16),
//             Text(
//               _error ?? 'Something went wrong',
//               textAlign: TextAlign.center,
//               style: TextStyle(
//                 color: isDark ? Colors.white70 : Colors.black54,
//                 fontSize: 16,
//               ),
//             ),
//             const SizedBox(height: 24),
//             ElevatedButton(
//               onPressed: _loadAdaptyData,
//               style: ElevatedButton.styleFrom(
//                 backgroundColor: AppColors.primary,
//                 foregroundColor: Colors.white,
//               ),
//               child: const Text('Retry'),
//             ),
//           ],
//         ),
//       ),
//     );
//   }

//   Widget _buildHeader(bool isDark) {
//     return Row(
//       mainAxisAlignment: MainAxisAlignment.center,
//       children: [
//         const Flexible(
//           child: Text(
//             'faithlock',
//             style: TextStyle(
//               letterSpacing: -0.5,
//               fontSize: 24,
//               fontWeight: FontWeight.bold,
//               color: AppColors.primary,
//             ),
//           ),
//         ),
//         const SizedBox(width: 6),
//         Container(
//           padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 3),
//           decoration: BoxDecoration(
//             color: AppColors.primary,
//             borderRadius: BorderRadius.circular(6),
//           ),
//           child: const Text(
//             'PRO',
//             style: TextStyle(
//                 color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
//           ),
//         ),
//       ],
//     );
//   }

//   Widget _buildVisualRepresentation() {
//     return Image.asset(
//       height: 130,
//       'assets/images/paywall-before-after.png',
//       fit: BoxFit.contain,
//     );
//   }

//   Widget _buildFeaturesList(bool isDark) {
//     final features = [
//       {'icon': Icons.record_voice_over, 'text': 'Unlimited live talks'},
//       {'icon': Icons.description_outlined, 'text': 'Auto summaries & insights'},
//       {'icon': Icons.favorite, 'text': 'Support the developer'},
//       {'icon': Icons.verified_user, 'text': 'Remove annoying paywall'},
//     ];

//     return Column(
//       children: features.asMap().entries.map((entry) {
//         final int index = entry.key;
//         final feature = entry.value;

//         return Padding(
//           padding:
//               EdgeInsets.only(bottom: index == features.length - 1 ? 0 : 8.0),
//           child: Row(
//             crossAxisAlignment: CrossAxisAlignment.center,
//             children: [
//               Container(
//                 width: 32,
//                 height: 32,
//                 decoration: BoxDecoration(
//                   color: AppColors.primary,
//                   borderRadius: BorderRadius.circular(8),
//                 ),
//                 child: Icon(
//                   feature['icon'] as IconData,
//                   color: Colors.white,
//                   size: 18,
//                 ),
//               ),
//               const SizedBox(width: 16),
//               Expanded(
//                 child: Text(
//                   feature['text'] as String,
//                   style: TextStyle(
//                     fontSize: 16,
//                     fontWeight: FontWeight.w500,
//                     color: isDark ? Colors.white : Colors.black87,
//                   ),
//                 ),
//               ),
//             ],
//           ),
//         );
//       }).toList(),
//     );
//   }

//   Widget _buildPricingPlans(bool isDark) {
//     if (_products.isEmpty) {
//       return _buildDefaultPricingPlans(isDark);
//     }

//     // Sort products by price (yearly first, then weekly/monthly)
//     final sortedProducts = List<AdaptyPaywallProduct>.from(_products)
//       ..sort((a, b) {
//         final aPeriod = _getSubscriptionPeriod(a);
//         final bPeriod = _getSubscriptionPeriod(b);

//         if (aPeriod == 'yearly' && bPeriod != 'yearly') return -1;
//         if (bPeriod == 'yearly' && aPeriod != 'yearly') return 1;

//         return a.price.amount.compareTo(b.price.amount);
//       });

//     return Column(
//       children: sortedProducts.asMap().entries.map((entry) {
//         final int index = entry.key;
//         final product = entry.value;
//         final isSelected = selectedPlan == index;
//         final period = _getSubscriptionPeriod(product);

//         return Column(
//           children: [
//             if (index > 0) const SizedBox(height: 12),
//             GestureDetector(
//               onTap: () => _selectPlan(index, period),
//               child: AnimatedBuilder(
//                 animation: _cardScaleAnimation,
//                 builder: (context, child) {
//                   return Transform.scale(
//                     scale: isSelected
//                         ? (1.0 + (_cardScaleAnimation.value * 0.005))
//                         : 1.0,
//                     child: child,
//                   );
//                 },
//                 child: AnimatedContainer(
//                   duration: const Duration(milliseconds: 200),
//                   curve: Curves.easeInOut,
//                   constraints: const BoxConstraints(minHeight: 50),
//                   padding: const EdgeInsets.all(12),
//                   decoration: BoxDecoration(
//                     color: isSelected
//                         ? AppColors.primaryLight.withValues(alpha: 0.04)
//                         : (isDark ? Colors.grey[800] : Colors.grey[50]),
//                     borderRadius: BorderRadius.circular(14),
//                     border: Border.all(
//                       color: isSelected
//                           ? AppColors.primary
//                           : (isDark ? Colors.grey[600]! : Colors.grey[200]!),
//                       width: isSelected ? 2 : 1,
//                     ),
//                   ),
//                   child: Row(
//                     children: [
//                       Expanded(
//                         child: Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             Text(
//                               _getPlanTitle(product),
//                               style: TextStyle(
//                                 fontSize: 17,
//                                 fontWeight: FontWeight.w600,
//                                 color: isDark ? Colors.white : Colors.black87,
//                               ),
//                             ),
//                             const SizedBox(height: 2),
//                             Text(
//                               _getPriceText(product),
//                               style: TextStyle(
//                                 fontSize: 15,
//                                 color: isDark ? Colors.white70 : Colors.black54,
//                               ),
//                             ),
//                           ],
//                         ),
//                       ),
//                       if (period == 'yearly') ...[
//                         Container(
//                           padding: const EdgeInsets.symmetric(
//                               horizontal: 12, vertical: 6),
//                           decoration: BoxDecoration(
//                             color: AppColors.primary,
//                             borderRadius: BorderRadius.circular(6),
//                           ),
//                           child: Text(
//                             _getSavingsText(product),
//                             style: const TextStyle(
//                               color: Colors.white,
//                               fontSize: 12,
//                               fontWeight: FontWeight.bold,
//                             ),
//                           ),
//                         ),
//                         const SizedBox(width: 8),
//                       ],
//                       if (isSelected)
//                         const Icon(
//                           Icons.check_circle,
//                           color: AppColors.primary,
//                           size: 24,
//                         )
//                       else
//                         Container(
//                           width: 24,
//                           height: 24,
//                           decoration: BoxDecoration(
//                             shape: BoxShape.circle,
//                             border: Border.all(
//                               color: isDark ? Colors.white54 : Colors.black26,
//                               width: 2,
//                             ),
//                           ),
//                         ),
//                     ],
//                   ),
//                 ),
//               ),
//             ),
//           ],
//         );
//       }).toList(),
//     );
//   }

//   Widget _buildDefaultPricingPlans(bool isDark) {
//     return Column(
//       children: [
//         // Yearly plan
//         GestureDetector(
//           onTap: () => _selectPlan(0, 'yearly'),
//           child: AnimatedBuilder(
//             animation: _cardScaleAnimation,
//             builder: (context, child) {
//               return Transform.scale(
//                 scale: selectedPlan == 0
//                     ? (1.0 + (_cardScaleAnimation.value * 0.005))
//                     : 1.0,
//                 child: child,
//               );
//             },
//             child: AnimatedContainer(
//               duration: const Duration(milliseconds: 200),
//               curve: Curves.easeInOut,
//               constraints: const BoxConstraints(minHeight: 50),
//               padding: const EdgeInsets.all(12),
//               decoration: BoxDecoration(
//                 color: selectedPlan == 0
//                     ? AppColors.primaryLight.withValues(alpha: 0.15)
//                     : (isDark ? Colors.grey[800] : Colors.grey[50]),
//                 borderRadius: BorderRadius.circular(14),
//                 border: Border.all(
//                   color: selectedPlan == 0
//                       ? AppColors.primary
//                       : (isDark ? Colors.grey[600]! : Colors.grey[200]!),
//                   width: selectedPlan == 0 ? 2 : 1,
//                 ),
//               ),
//               child: Row(
//                 children: [
//                   Expanded(
//                     child: Column(
//                       crossAxisAlignment: CrossAxisAlignment.start,
//                       children: [
//                         Text(
//                           'Yearly Plan',
//                           style: TextStyle(
//                             fontSize: 17,
//                             fontWeight: FontWeight.w600,
//                             color: isDark ? Colors.white : Colors.black87,
//                           ),
//                         ),
//                         const SizedBox(height: 2),
//                         Text(
//                           '\$US 24.99 per year',
//                           style: TextStyle(
//                             fontSize: 15,
//                             color: isDark ? Colors.white70 : Colors.black54,
//                           ),
//                         ),
//                       ],
//                     ),
//                   ),
//                   Container(
//                     padding:
//                         const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
//                     decoration: BoxDecoration(
//                       color: AppColors.primary,
//                       borderRadius: BorderRadius.circular(6),
//                     ),
//                     child: Text(
//                       _getDefaultSavingsText(),
//                       style: const TextStyle(
//                         color: Colors.white,
//                         fontSize: 12,
//                         fontWeight: FontWeight.bold,
//                       ),
//                     ),
//                   ),
//                   const SizedBox(width: 8),
//                   if (selectedPlan == 0)
//                     const Icon(
//                       Icons.check_circle,
//                       color: AppColors.primary,
//                       size: 24,
//                     )
//                   else
//                     Container(
//                       width: 24,
//                       height: 24,
//                       decoration: BoxDecoration(
//                         shape: BoxShape.circle,
//                         border: Border.all(
//                           color: isDark ? Colors.white54 : Colors.black26,
//                           width: 2,
//                         ),
//                       ),
//                     ),
//                 ],
//               ),
//             ),
//           ),
//         ),
//         const SizedBox(height: 12),
//         // Weekly plan
//         GestureDetector(
//           onTap: () => _selectPlan(1, 'weekly'),
//           child: AnimatedBuilder(
//             animation: _cardScaleAnimation,
//             builder: (context, child) {
//               return Transform.scale(
//                 scale: selectedPlan == 1
//                     ? (1.0 + (_cardScaleAnimation.value * 0.005))
//                     : 1.0,
//                 child: child,
//               );
//             },
//             child: AnimatedContainer(
//               duration: const Duration(milliseconds: 200),
//               curve: Curves.easeInOut,
//               constraints: const BoxConstraints(minHeight: 50),
//               padding: const EdgeInsets.all(12),
//               decoration: BoxDecoration(
//                 color: selectedPlan == 1
//                     ? AppColors.primaryLight.withValues(alpha: 0.15)
//                     : (isDark ? Colors.grey[800] : Colors.grey[50]),
//                 borderRadius: BorderRadius.circular(14),
//                 border: Border.all(
//                   color: selectedPlan == 1
//                       ? AppColors.primary
//                       : (isDark ? Colors.grey[600]! : Colors.grey[200]!),
//                   width: selectedPlan == 1 ? 2 : 1,
//                 ),
//               ),
//               child: Row(
//                 children: [
//                   Expanded(
//                     child: Column(
//                       crossAxisAlignment: CrossAxisAlignment.start,
//                       children: [
//                         Text(
//                           'Weekly Plan',
//                           style: TextStyle(
//                             fontSize: 17,
//                             fontWeight: FontWeight.w600,
//                             color: isDark ? Colors.white : Colors.black87,
//                           ),
//                         ),
//                         const SizedBox(height: 2),
//                         Text(
//                           'then \$US 7.99 per week',
//                           style: TextStyle(
//                             fontSize: 15,
//                             color: isDark ? Colors.white70 : Colors.black54,
//                           ),
//                         ),
//                       ],
//                     ),
//                   ),
//                   if (selectedPlan == 1)
//                     const Icon(
//                       Icons.check_circle,
//                       color: AppColors.primary,
//                       size: 24,
//                     )
//                   else
//                     Container(
//                       width: 24,
//                       height: 24,
//                       decoration: BoxDecoration(
//                         shape: BoxShape.circle,
//                         border: Border.all(
//                           color: isDark ? Colors.white54 : Colors.black26,
//                           width: 2,
//                         ),
//                       ),
//                     ),
//                 ],
//               ),
//             ),
//           ),
//         ),
//       ],
//     );
//   }

//   String _getSubscriptionPeriod(AdaptyPaywallProduct product) {
//     // Analyze product ID to determine period
//     final productId = product.vendorProductId.toLowerCase();

//     if (productId.contains('year') || productId.contains('annual')) {
//       return 'yearly';
//     } else if (productId.contains('month') || productId.contains('monthly')) {
//       return 'monthly';
//     } else if (productId.contains('week') || productId.contains('weekly')) {
//       return 'weekly';
//     }

//     final amount = product.price.amount;
//     if (amount > 100) {
//       return 'yearly';
//     } else if (amount > 10) {
//       return 'monthly';
//     } else {
//       return 'weekly';
//     }
//   }

//   String _getPlanTitle(AdaptyPaywallProduct product) {
//     final period = _getSubscriptionPeriod(product);
//     switch (period) {
//       case 'yearly':
//         return 'Yearly Plan';
//       case 'monthly':
//         return 'Monthly Plan';
//       case 'weekly':
//         return 'Weekly Plan';
//       default:
//         return 'Premium Plan';
//     }
//   }

//   String _getPriceText(AdaptyPaywallProduct product) {
//     final price = product.price.localizedString;
//     final period = _getSubscriptionPeriod(product);

//     switch (period) {
//       case 'yearly':
//         return '$price per year';
//       case 'monthly':
//         return '$price per month';
//       case 'weekly':
//         return '$price per week';
//       default:
//         return price ?? '\$${product.price.amount}';
//     }
//   }

//   String _getSavingsText(AdaptyPaywallProduct product) {
//     // Find the most expensive product (typically weekly/monthly) to compare against yearly
//     final yearlyProduct = product;
//     AdaptyPaywallProduct? comparisonProduct;
//     double comparisonAnnualCost = 0.0;

//     // Find a suitable comparison product (weekly or monthly)
//     for (final p in _products) {
//       final period = _getSubscriptionPeriod(p);
//       if (period != 'yearly' && p.vendorProductId != product.vendorProductId) {
//         double annualEquivalent = 0.0;

//         if (period == 'weekly') {
//           annualEquivalent = p.price.amount * 52; // 52 weeks per year
//         } else if (period == 'monthly') {
//           annualEquivalent = p.price.amount * 12; // 12 months per year
//         }

//         // Use the product with highest annual equivalent cost for comparison
//         if (annualEquivalent > comparisonAnnualCost) {
//           comparisonProduct = p;
//           comparisonAnnualCost = annualEquivalent;
//         }
//       }
//     }

//     // Calculate savings percentage
//     if (comparisonProduct != null &&
//         comparisonAnnualCost > yearlyProduct.price.amount) {
//       final savings = ((comparisonAnnualCost - yearlyProduct.price.amount) /
//               comparisonAnnualCost *
//               100)
//           .round();
//       return 'SAVE $savings%';
//     }

//     // Fallback to default if no comparison product found or no savings
//     return 'SAVE 90%';
//   }

//   String _getDefaultSavingsText() {
//     // Calculate savings for default pricing: $24.99 yearly vs $7.99 weekly
//     const double yearlyPrice = 24.99;
//     const double weeklyPrice = 7.99;
//     const double weeklyAnnualEquivalent = weeklyPrice * 52; // $415.48 per year

//     final savings =
//         ((weeklyAnnualEquivalent - yearlyPrice) / weeklyAnnualEquivalent * 100)
//             .round();
//     return 'SAVE $savings%';
//   }

//   Widget _buildFreeTrialToggle(bool isDark) {
//     return Container(
//       padding: const EdgeInsets.all(12),
//       decoration: BoxDecoration(
//         color: isDark ? Colors.grey[800] : Colors.grey[50],
//         borderRadius: BorderRadius.circular(12),
//       ),
//       child: Row(
//         mainAxisAlignment: MainAxisAlignment.spaceBetween,
//         children: [
//           Text(
//             'Free Trial Enabled',
//             style: TextStyle(
//               fontSize: 16,
//               fontWeight: FontWeight.w500,
//               color: isDark ? Colors.white : Colors.black87,
//             ),
//           ),
//           AnimatedBuilder(
//             animation: _switchAnimation,
//             builder: (context, child) {
//               return Transform.scale(
//                 scale: 1.0 + (_switchAnimation.value * 0.01),
//                 child: CupertinoSwitch(
//                   value: freeTrialEnabled,
//                   onChanged: _toggleFreeTrialWithPlanSelection,
//                   activeTrackColor: AppColors.primary,
//                 ),
//               );
//             },
//           ),
//         ],
//       ),
//     );
//   }

//   Widget _buildUnlockButton() {
//     return Container(
//       width: double.infinity,
//       height: 48,
//       decoration: BoxDecoration(
//         color: AppColors.primary,
//         borderRadius: BorderRadius.circular(12),
//         boxShadow: [
//           BoxShadow(
//             color: AppColors.primary.withValues(alpha: 0.3),
//             offset: const Offset(0, 2),
//             blurRadius: 8,
//           ),
//         ],
//       ),
//       child: ElevatedButton(
//         onPressed: _isPurchasing ? null : _handleUnlockPressed,
//         style: ElevatedButton.styleFrom(
//           backgroundColor: _isPurchasing
//               ? AppColors.primary.withValues(alpha: 0.7)
//               : AppColors.primary,
//           foregroundColor: Colors.white,
//           elevation: 0,
//           shadowColor: Colors.transparent,
//           shape: RoundedRectangleBorder(
//             borderRadius: BorderRadius.circular(12),
//           ),
//         ),
//         child: _isPurchasing
//             ? const Row(
//                 mainAxisAlignment: MainAxisAlignment.center,
//                 children: [
//                   SizedBox(
//                     width: 18,
//                     height: 18,
//                     child: CircularProgressIndicator.adaptive(
//                       strokeWidth: 2,
//                       valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
//                     ),
//                   ),
//                   SizedBox(width: 12),
//                   Text(
//                     'Processing...',
//                     style: TextStyle(
//                       fontSize: 16,
//                       fontWeight: FontWeight.w600,
//                       color: Colors.white,
//                     ),
//                   ),
//                 ],
//               )
//             : Row(
//                 mainAxisAlignment: MainAxisAlignment.center,
//                 children: [
//                   Text(
//                     freeTrialEnabled ? 'Start Your Free Trial' : 'Unlock Now',
//                     style: const TextStyle(
//                       fontSize: 16,
//                       fontWeight: FontWeight.w600,
//                       color: Colors.white,
//                     ),
//                   ),
//                   const SizedBox(width: 6),
//                   const Icon(
//                     Icons.arrow_forward,
//                     color: Colors.white,
//                     size: 18,
//                   ),
//                 ],
//               ),
//       ),
//     );
//   }

//   Widget _buildFooterLinks(bool isDark) {
//     return Row(
//       mainAxisAlignment: MainAxisAlignment.spaceBetween,
//       children: [
//         TextButton(
//           onPressed: _handleRestorePressed,
//           child: Text(
//             'Restore',
//             style: TextStyle(
//               color: isDark ? Colors.white70 : Colors.black54,
//               fontSize: 14,
//               fontWeight: FontWeight.w500,
//             ),
//           ),
//         ),
//         Flexible(
//           child: TextButton(
//             onPressed: _handleTermsPressed,
//             child: Text(
//               'Terms',
//               textAlign: TextAlign.center,
//               style: TextStyle(
//                 color: isDark ? Colors.white70 : Colors.black54,
//                 fontSize: 14,
//                 fontWeight: FontWeight.w500,
//               ),
//             ),
//           ),
//         ),
//         TextButton(
//           onPressed: () => _handleTermsPressed(isPrivacy: true),
//           child: Text(
//             'Privacy',
//             style: TextStyle(
//               color: isDark ? Colors.white70 : Colors.black54,
//               fontSize: 14,
//               fontWeight: FontWeight.w500,
//             ),
//           ),
//         ),
//       ],
//     );
//   }

//   void _handleUnlockPressed() async {
//     if (mounted) {
//       Feedback.forTap(context);
//     }
//     if (_isPurchasing) return;

//     setState(() {
//       _isPurchasing = true;
//     });

//     try {
//       if (_products.isNotEmpty && selectedPlan < _products.length) {
//         final selectedProduct = _products[selectedPlan];
//         final result = await _adaptyService.makePurchase(selectedProduct);

//         if (result != null) {
//           switch (result) {
//             case AdaptyPurchaseResultSuccess():
//               Get.snackbar(
//                 'Success',
//                 'Purchase successful! Welcome to faithlock Pro!',
//                 backgroundColor: Colors.green,
//                 colorText: Colors.white,
//               );
//               if (mounted) {
//                 Get.offAll(AppRoutes.mainRoute);
//               }
//               break;
//             case AdaptyPurchaseResultUserCancelled():
//               Get.snackbar(
//                 'Cancelled',
//                 'Purchase was cancelled.',
//                 backgroundColor: Colors.orange,
//                 colorText: Colors.white,
//               );
//               break;
//             case AdaptyPurchaseResultPending():
//               Get.snackbar(
//                 'Pending',
//                 'Purchase is pending. Please check your payment method.',
//                 backgroundColor: Colors.blue,
//                 colorText: Colors.white,
//               );
//               break;
//           }
//         }
//       } else {
//         await _adaptyService.showPaywall('primary');
//       }
//     } catch (e) {
//       Get.snackbar(
//         'Error',
//         'Failed to process purchase. Please try again.',
//         backgroundColor: Colors.red,
//         colorText: Colors.white,
//       );
//     } finally {
//       if (mounted) {
//         setState(() {
//           _isPurchasing = false;
//         });
//       }
//     }
//   }

//   void _handleRestorePressed() async {
//     try {
//       final profile = await _adaptyService.restorePurchases();
//       if (profile?.accessLevels['premium']?.isActive ?? false) {
//         Get.snackbar(
//           'Success',
//           'Purchases restored successfully!',
//           backgroundColor: Colors.green,
//           colorText: Colors.white,
//         );
//         if (mounted) {
//           Navigator.of(context).pop();
//         }
//       } else {
//         Get.snackbar(
//           'Info',
//           'No active subscriptions found.',
//           backgroundColor: Colors.orange,
//           colorText: Colors.white,
//         );
//       }
//     } catch (e) {
//       Get.snackbar(
//         'Error',
//         'Failed to restore purchases. Please try again.',
//         backgroundColor: Colors.red,
//         colorText: Colors.white,
//       );
//     }
//   }

//   void _handleTermsPressed({bool isPrivacy = false}) async {
//     const termsUrl =
//         'https://appbiz-studio.com/apps/faithlock/terms-of-service.html';
//     const privacyUrl =
//         'https://appbiz-studio.com/apps/faithlock/privacy-policy.html';

//     final url = isPrivacy ? privacyUrl : termsUrl;

//     try {
//       await launchUrl(Uri.parse(url), mode: LaunchMode.inAppBrowserView);
//     } catch (e) {
//       Get.snackbar(
//         'Error',
//         'Could not open the link.',
//         backgroundColor: Colors.red,
//         colorText: Colors.white,
//       );
//     }
//   }
// }
